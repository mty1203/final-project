# TSV + Probe å®éªŒæµç¨‹æ€»ç»“

## ğŸ“Š å½“å‰çŠ¶æ€

âœ… **æ‰€æœ‰ 5 ä¸ªæ­¥éª¤å·²å®Œæˆï¼**

---

## ğŸ”„ å®éªŒæµç¨‹è¯¦è§£

### æ­¥éª¤ 1: ç”Ÿæˆ Most-Likely ç­”æ¡ˆ âœ…

**ç›®çš„**: è®©æ¨¡å‹å¯¹ TruthfulQA çš„æ¯ä¸ªé—®é¢˜ç”Ÿæˆç­”æ¡ˆï¼Œä½œä¸ºè®­ç»ƒæ•°æ®åŸºç¡€ã€‚

**è¿è¡Œå‘½ä»¤**:
```bash
python tsv_main.py \
  --model_name gpt-neo-1.3B \
  --dataset_name tqa \
  --gene 1 \
  --most_likely 1
```

**è¾“å‡ºç»“æœ**:
- æ–‡ä»¶: `save_for_eval/tqa_hal_det/answers/*.npy`
- æ•°é‡: **1634 ä¸ªæ–‡ä»¶** (åŒ…å« gpt-neo-1.3B å’Œ llama3.1-8B çš„ç­”æ¡ˆ)
- å†…å®¹: æ¯ä¸ªæ–‡ä»¶å­˜å‚¨ä¸€ä¸ªé—®é¢˜çš„ç”Ÿæˆç­”æ¡ˆï¼ˆnumpy æ•°ç»„ï¼‰

**ä½œç”¨**: è¿™äº›ç­”æ¡ˆå°†ç”¨äºï¼š
1. è®­ç»ƒ TSV æ—¶åŒºåˆ†"çœŸå®"å’Œ"å¹»è§‰"ç­”æ¡ˆ
2. è®­ç»ƒ Probe æ—¶æå–éšè—çŠ¶æ€ä½œä¸ºç‰¹å¾

---

### æ­¥éª¤ 2: ç”Ÿæˆ BLEURT Ground Truth åˆ†æ•° âœ…

**ç›®çš„**: ç”¨ BLEURT è¯„ä¼°æ¯ä¸ªç­”æ¡ˆçš„è´¨é‡ï¼Œä½œä¸º"æ˜¯å¦å¹»è§‰"çš„ç›‘ç£ä¿¡å·ã€‚

**è¿è¡Œå‘½ä»¤**:
```bash
python tsv_main.py \
  --model_name gpt-neo-1.3B \
  --dataset_name tqa \
  --generate_gt 1 \
  --most_likely 1
```

**è¾“å‡ºç»“æœ**:
- æ–‡ä»¶: `ml_tqa_bleurt_score.npy`
- æ ·æœ¬æ•°: **817 ä¸ª**
- å¹³å‡åˆ†: **0.465**
- åˆ†æ•°èŒƒå›´: **[0.074, 0.958]**
- å¹»è§‰æ¯”ä¾‹: **57.3%** (BLEURT < 0.5)

**ä½œç”¨**: 
- BLEURT åˆ†æ•° â‰¥ 0.5 â†’ ç­”æ¡ˆæ¥è¿‘å‚è€ƒï¼Œæ ‡è®°ä¸º"çœŸå®"
- BLEURT åˆ†æ•° < 0.5 â†’ ç­”æ¡ˆåç¦»å‚è€ƒï¼Œæ ‡è®°ä¸º"å¹»è§‰"
- è¿™ä¸ªæ ‡ç­¾ç”¨äº TSV è®­ç»ƒå’Œ Probe è®­ç»ƒ

---

### æ­¥éª¤ 3: è®­ç»ƒ TSV å‘é‡ âœ…

**ç›®çš„**: å­¦ä¹ ä¸€ä¸ª"å¼•å¯¼å‘é‡"ï¼Œå°†éšè—çŠ¶æ€æ¨å‘æ›´çœŸå®çš„æ–¹å‘ã€‚

**è¿è¡Œå‘½ä»¤**:
```bash
python tsv_main.py \
  --model_name gpt-neo-1.3B \
  --dataset_name tqa \
  --component res \
  --str_layer 9 \
  --save_tsv_path artifacts/gpt-neo-1.3B_tqa_tsv.pt
```

**è¾“å‡ºç»“æœ**:
- æ–‡ä»¶: `artifacts/gpt-neo-1.3B_tqa_tsv.pt`
- TSV ç»´åº¦: **[2048]** (ä¸ gpt-neo-1.3B çš„ hidden_size ä¸€è‡´)
- TSV èŒƒæ•°: **6.944**
- ä½œç”¨å±‚: **ç¬¬ 9 å±‚ residual stream**

**æ ¸å¿ƒåŸç†**:
1. å°†æ ·æœ¬åˆ†ä¸º"çœŸå®ç°‡"å’Œ"å¹»è§‰ç°‡"ï¼ˆåŸºäº BLEURT åˆ†æ•°ï¼‰
2. ä½¿ç”¨ Optimal Transport Loss è®©ä¸¤ä¸ªç°‡åœ¨éšè—ç©ºé—´åˆ†ç¦»
3. TSV å‘é‡ = çœŸå®ç°‡ä¸­å¿ƒ - å¹»è§‰ç°‡ä¸­å¿ƒ
4. åœ¨ç”Ÿæˆæ—¶ï¼Œå°†éšè—çŠ¶æ€ `h` è°ƒæ•´ä¸º `h + Î±Â·TSV`ï¼Œæ¨å‘çœŸå®æ–¹å‘

**è®­ç»ƒè¿‡ç¨‹**:
- ä½¿ç”¨ 16 ä¸ª exemplar (å…¸å‹æ ·æœ¬) 
- æ¯è½®è¿­ä»£ 32 ä¸ª selected æ ·æœ¬
- OT loss ç³»æ•° Î» = 5
- ä½¿ç”¨ EMA (æŒ‡æ•°ç§»åŠ¨å¹³å‡) æ›´æ–°ç°‡ä¸­å¿ƒ

---

### æ­¥éª¤ 4: è®­ç»ƒ Hallucination Probe âœ…

**ç›®çš„**: è®­ç»ƒä¸€ä¸ªè½»é‡çº§åˆ†ç±»å™¨ï¼Œå®æ—¶åˆ¤æ–­"å½“å‰ token æ˜¯å¦å¯èƒ½å¯¼è‡´å¹»è§‰"ã€‚

**è¿è¡Œå‘½ä»¤**:
```bash
python experiments/tsv_probe_generation/train_probe.py \
  --model_name EleutherAI/gpt-neo-1.3B \
  --dataset tqa \
  --layer_id 9 \
  --max_samples 500 \
  --epochs 3 \
  --output_path artifacts/probe_weights.pt
```

**è¾“å‡ºç»“æœ**:
- æ–‡ä»¶: `artifacts/probe_weights.pt`
- æƒé‡ç»´åº¦: **[1, 2048]**
- æƒé‡èŒƒæ•°: **0.643**
- åç½®: **0.004**
- è®­ç»ƒå‡†ç¡®ç‡: **68.8%**

**æ ¸å¿ƒåŸç†**:
1. å¯¹æ¯ä¸ªç­”æ¡ˆï¼Œæå–ç¬¬9å±‚æœ€åä¸€ä¸ª token çš„éšè—çŠ¶æ€ (2048ç»´)
2. æ ¹æ® BLEURT æ‰“æ ‡ç­¾: < 0.5 â†’ å¹»è§‰(1), â‰¥ 0.5 â†’ çœŸå®(0)
3. è®­ç»ƒçº¿æ€§åˆ†ç±»å™¨: `risk = sigmoid(WÂ·h + b)`
4. è¾“å‡º risk âˆˆ [0, 1]ï¼Œè¶Šé«˜è¡¨ç¤ºè¶Šå¯èƒ½å¹»è§‰

**è®­ç»ƒæ•°æ®**:
- ä½¿ç”¨äº† 500 ä¸ªæ ·æœ¬ (å¯æ‰©å±•åˆ° 2000)
- è®­ç»ƒ 3 epochs
- å­¦ä¹ ç‡ 1e-3

---

### æ­¥éª¤ 5: TSV + Probe è”åˆå¼•å¯¼ç”Ÿæˆ âœ…

**ç›®çš„**: åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œæ ¹æ® Probe åˆ¤æ–­çš„é£é™©ï¼ŒåŠ¨æ€æ³¨å…¥ TSV æ¥é™ä½å¹»è§‰ã€‚

**è¿è¡Œå‘½ä»¤**:
```bash
python experiments/tsv_probe_generation/steer_with_probe.py \
  --model_name EleutherAI/gpt-neo-1.3B \
  --tsv_path artifacts/gpt-neo-1.3B_tqa_tsv.pt \
  --probe_path artifacts/probe_weights.pt \
  --layer_id 9 \
  --risk_threshold 0.7 \
  --steer_alpha 1.0 \
  --num_samples 10
```

**æµ‹è¯•ç»“æœ** (10ä¸ªæ ·æœ¬):
- å¹³å‡é£é™©: **0.509**
- è§¦å‘ç‡: **18.1%** (18.1% çš„ token è§¦å‘äº† TSV å¼•å¯¼)
- å¹»è§‰ç‡: **100%** (ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼ŒéçœŸå® TruthfulQA)

**ç”Ÿæˆæµç¨‹** (æ¯ä¸ª token):
```
1. æ¨¡å‹å‰å‘ä¼ æ’­ â†’ è·å–éšè—çŠ¶æ€ h
2. Probe åˆ¤æ–­ â†’ risk = sigmoid(WÂ·h + b)
3. å¦‚æœ risk > threshold (0.7):
   - è°ƒæ•´éšè—çŠ¶æ€: h' = h + Î±Â·riskÂ·TSV
   - é‡æ–°è®¡ç®— logits': lm_head(h')
   - æ··åˆ: final_logits = 0.3Â·logits + 0.7Â·logits'
4. é‡‡æ ·ä¸‹ä¸€ä¸ª token
```

**å…³é”®å‚æ•°**:
- `risk_threshold`: è¶…è¿‡æ­¤é£é™©æ‰è§¦å‘ steering
- `steer_alpha`: Steering å¼ºåº¦ç³»æ•°
- `steer_mix`: Steered å’ŒåŸå§‹ logits çš„æ··åˆæ¯”ä¾‹

---

## ğŸ“ˆ æ•°æ®æµå›¾

```
TruthfulQA æ•°æ®é›† (817 ä¸ªé—®é¢˜)
    â†“
[æ­¥éª¤1] ç”Ÿæˆç­”æ¡ˆ
    â†“
most_likely_hal_det_*.npy (1634 ä¸ªç­”æ¡ˆæ–‡ä»¶)
    â†“
[æ­¥éª¤2] BLEURT è¯„ä¼°
    â†“
ml_tqa_bleurt_score.npy (817 ä¸ªåˆ†æ•°)
    â†“                         â†“
    â†“                    [æ­¥éª¤4] è®­ç»ƒ Probe
    â†“                         â†“
    â†“                    probe_weights.pt
    â†“                         â†“
[æ­¥éª¤3] è®­ç»ƒ TSV â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
gpt-neo-1.3B_tqa_tsv.pt
    â†“
[æ­¥éª¤5] è”åˆå¼•å¯¼ç”Ÿæˆ
    â†“
ç”Ÿæˆæ–‡æœ¬ + é£é™©è½¨è¿¹ + è¯„ä¼°æŒ‡æ ‡
```

---

## ğŸ” æ¯ä¸ªæ­¥éª¤åœ¨å¹²ä»€ä¹ˆ

### æ­¥éª¤ 1 & 2: æ•°æ®å‡†å¤‡é˜¶æ®µ
- **ä½œç”¨**: ç”Ÿæˆè®­ç»ƒæ•°æ®å¹¶æ‰“ä¸Š"æ˜¯å¦å¹»è§‰"çš„æ ‡ç­¾
- **è¾“å…¥**: TruthfulQA åŸå§‹é—®é¢˜
- **è¾“å‡º**: æ¨¡å‹ç”Ÿæˆçš„ç­”æ¡ˆ + BLEURT è´¨é‡åˆ†æ•°
- **ä¸ºä»€ä¹ˆéœ€è¦**: TSV å’Œ Probe éƒ½éœ€è¦çŸ¥é“"ä»€ä¹ˆæ˜¯çœŸå®ç­”æ¡ˆï¼Œä»€ä¹ˆæ˜¯å¹»è§‰ç­”æ¡ˆ"

### æ­¥éª¤ 3: å­¦ä¹ "çœŸå®æ–¹å‘"
- **ä½œç”¨**: åœ¨éšè—ç©ºé—´ä¸­æ‰¾åˆ°ä¸€ä¸ªæ–¹å‘ï¼Œæ²¿è¿™ä¸ªæ–¹å‘èµ° â†’ è¾“å‡ºæ›´çœŸå®
- **æ–¹æ³•**: èšç±» + Optimal Transportï¼Œè®©çœŸå®/å¹»è§‰æ ·æœ¬åœ¨ç©ºé—´ä¸­åˆ†ç¦»
- **è¾“å‡º**: TSV å‘é‡ï¼ˆä¸€ä¸ª 2048 ç»´çš„å‘é‡ï¼‰
- **æ¯”å–»**: å°±åƒç»™æ¨¡å‹è£…äº†ä¸€ä¸ª"ç½—ç›˜"ï¼ŒæŒ‡å‘"çœŸå®"çš„æ–¹å‘

### æ­¥éª¤ 4: å­¦ä¹ "é£é™©æ£€æµ‹å™¨"
- **ä½œç”¨**: è®­ç»ƒä¸€ä¸ª"çœ‹é—¨äºº"ï¼Œèƒ½åˆ¤æ–­å½“å‰ç”Ÿæˆæ˜¯å¦æœ‰é£é™©
- **æ–¹æ³•**: çº¿æ€§åˆ†ç±»å™¨ï¼Œè¾“å…¥éšè—çŠ¶æ€ â†’ è¾“å‡ºé£é™©æ¦‚ç‡
- **è¾“å‡º**: Probe æƒé‡ï¼ˆä¸€ä¸ªæƒé‡çŸ©é˜µ + åç½®ï¼‰
- **æ¯”å–»**: å°±åƒç»™æ¨¡å‹è£…äº†ä¸€ä¸ª"æŠ¥è­¦å™¨"ï¼Œé£é™©é«˜æ—¶å°±å“é“ƒ

### æ­¥éª¤ 5: è”åˆå¼•å¯¼ç”Ÿæˆ
- **ä½œç”¨**: åœ¨ç”Ÿæˆæ—¶ï¼Œç”¨ Probe ç›‘æ§é£é™©ï¼Œç”¨ TSV çº æ­£æ–¹å‘
- **æµç¨‹**: 
  1. Probe: "å½“å‰é£é™© 0.85ï¼Œå¾ˆå±é™©ï¼"
  2. TSV: "å¥½çš„ï¼Œæˆ‘æ¥è°ƒæ•´ä¸€ä¸‹æ–¹å‘"
  3. æ¨¡å‹: ç”Ÿæˆæ›´å®‰å…¨çš„ token
- **æ¯”å–»**: Probe æ˜¯"å¯¼èˆª"ï¼ŒTSV æ˜¯"æ–¹å‘ç›˜"ï¼ŒååŒå·¥ä½œé¿å¼€"å¹»è§‰é™·é˜±"

---

## âœ… éªŒè¯ç»“æœ

è¿è¡ŒéªŒè¯è„šæœ¬æ£€æŸ¥æ‰€æœ‰æ­¥éª¤:
```bash
cd /home/mty/cs762/tsv-main
bash experiments/verify_pipeline.sh
```

**å½“å‰çŠ¶æ€**: æµç¨‹å®Œæˆåº¦ **5/5** âœ“

æ‰€æœ‰å¿…éœ€æ–‡ä»¶:
- âœ… ç­”æ¡ˆæ–‡ä»¶: 1634 ä¸ª
- âœ… BLEURT åˆ†æ•°: 817 ä¸ªæ ·æœ¬
- âœ… TSV å‘é‡: 2048 ç»´ï¼ŒèŒƒæ•° 6.944
- âœ… Probe æƒé‡: 2049 ä¸ªå‚æ•°ï¼Œå‡†ç¡®ç‡ 68.8%
- âœ… ç”Ÿæˆæ—¥å¿—: å·²è¿è¡Œ 1 æ¬¡æµ‹è¯•

---

## ğŸš€ ä¸‹ä¸€æ­¥: å®Œæ•´å®éªŒ

### å»ºè®®çš„å¯¹æ¯”å®éªŒ

1. **Baseline (æ—  Steering)**
```bash
python experiments/tsv_probe_generation/steer_with_probe.py \
  --model_name EleutherAI/gpt-neo-1.3B \
  --tsv_path artifacts/gpt-neo-1.3B_tqa_tsv.pt \
  --probe_path artifacts/probe_weights.pt \
  --layer_id 9 \
  --steer_alpha 0.0 \
  --num_samples 100 \
  --output_dir experiments/tsv_probe_generation/logs/baseline
```

2. **å¼± Steering (Î±=0.5)**
```bash
python experiments/tsv_probe_generation/steer_with_probe.py \
  --steer_alpha 0.5 \
  --num_samples 100 \
  --output_dir experiments/tsv_probe_generation/logs/alpha_0.5
```

3. **æ ‡å‡† Steering (Î±=1.0)**
```bash
python experiments/tsv_probe_generation/steer_with_probe.py \
  --steer_alpha 1.0 \
  --num_samples 100 \
  --output_dir experiments/tsv_probe_generation/logs/alpha_1.0
```

4. **å¼º Steering (Î±=1.5)**
```bash
python experiments/tsv_probe_generation/steer_with_probe.py \
  --steer_alpha 1.5 \
  --num_samples 100 \
  --output_dir experiments/tsv_probe_generation/logs/alpha_1.5
```

### å…³é”®æŒ‡æ ‡å¯¹æ¯”

å¯¹æ¯”ä¸åŒé…ç½®ä¸‹çš„:
- **å¹»è§‰ç‡** (è¶Šä½è¶Šå¥½)
- **BLEURT åˆ†æ•°** (æ–‡æœ¬è´¨é‡ï¼Œä¸åº”ä¸‹é™å¤ªå¤š)
- **å¹³å‡é£é™©** (Probe åˆ¤æ–­çš„å¹³å‡é£é™©)
- **è§¦å‘ç‡** (å¤šå°‘ token è¢« steering)

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- è¯¦ç»†å®éªŒæŒ‡å—: `experiments/EXPERIMENT_GUIDE.md`
- Baseline å®éªŒ: `experiments/gptneo_tqa_baseline/README.md`
- TSV+Probe æ¡†æ¶: `experiments/tsv_probe_generation/README.md`
- éªŒè¯è„šæœ¬: `experiments/verify_pipeline.sh`

---

## ğŸ¯ æ ¸å¿ƒåˆ›æ–°ç‚¹

1. **åœ¨çº¿ç›‘æ§**: Probe å®æ—¶åˆ¤æ–­æ¯ä¸ª token çš„é£é™©
2. **åŠ¨æ€å¹²é¢„**: åªåœ¨é«˜é£é™©æ—¶æ‰æ³¨å…¥ TSVï¼Œä¸å½±å“æ­£å¸¸ç”Ÿæˆ
3. **å¯è§£é‡Šæ€§**: å¯ä»¥è¿½è¸ªæ¯ä¸ª token çš„é£é™©è½¨è¿¹å’Œå¹²é¢„æ—¶æœº
4. **è½»é‡çº§**: Probe åªæ˜¯ä¸€ä¸ªçº¿æ€§å±‚ï¼Œæ¨ç†å¼€é”€æå°

---

**ç¥å®éªŒé¡ºåˆ©ï¼** ğŸ‰

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒ `experiments/EXPERIMENT_GUIDE.md` è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚

